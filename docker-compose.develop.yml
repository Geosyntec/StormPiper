services:
  stormpiper-pod:
    build:
      context: .
      dockerfile: Dockerfile
      target: stormpiper-pod
    command: bash /start-reload.sh
    image: stormpiper-pod
    environment:
      NEREID_ASYNC_MODE: none
    env_file:
      ## comment these out to work on front end.
      # - ./stormpiper/.env
      # - .env

      ## add this to work on front end.
      - .env-dev
      ## comment these out to work on front end.
      - ./stormpiper/.env
      - .env
    ports:
      - published: 8080
        target: 80
    volumes:
      - ./stormpiper/stormpiper:/stormpiper/stormpiper
      - ./stormpiper/alembic:/stormpiper/alembic

  stormpiper-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: stormpiper-test
    environment:
      NEREID_ASYNC_MODE: none
    env_file:
      ## add this to work on front end.
      - .env-test

    volumes:
      - ./stormpiper/stormpiper:/stormpiper/stormpiper

  bg_worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: bg_worker
    command: bash /run-worker.sh
    image: bg_worker
    environment:
      NEREID_ASYNC_MODE: none
    env_file:
      ## add this to work on front end.
      - .env-dev
      ## comment these out to work on front end.
      - ./stormpiper/.env
      - .env
    volumes:
      - ./stormpiper/stormpiper:/stormpiper/stormpiper

  beat_worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: bg_worker
    command: bash /run-beat.sh
    environment:
      NEREID_ASYNC_MODE: none
      STP_ENABLE_BEAT_SCHEDULE: true
    env_file:
      ## add this to work on front end.
      - .env-dev
      ## comment these out to work on front end.
      - ./stormpiper/.env
      - .env
    volumes:
      - ./stormpiper/stormpiper:/stormpiper/stormpiper
  
  redis:
    build:
      context: .
      dockerfile: Dockerfile
      target: redis
    image: redis
    ports:
      - target: 6379
        published: 6379
